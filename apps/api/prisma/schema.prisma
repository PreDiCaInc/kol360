generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DB_DIRECT_URL")
}

model Client {
  id                     String                  @id @default(cuid())
  name                   String
  type                   ClientType              @default(FULL)
  isLite                 Boolean                 @default(false)
  logoUrl                String?
  primaryColor           String                  @default("#0066CC")
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  campaigns              Campaign[]
  liteClientDiseaseAreas LiteClientDiseaseArea[]
  users                  User[]
  hcpExclusions          ClientHcpExclusion[]

  @@index([type])
  @@index([isActive])
  @@index([isLite])
}

model User {
  id          String     @id @default(cuid())
  cognitoSub  String     @unique
  email       String     @unique
  firstName   String
  lastName    String
  role        UserRole
  status      UserStatus @default(PENDING_VERIFICATION)
  clientId    String?
  approvedAt  DateTime?
  approvedBy  String?
  lastLoginAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  auditLogs   AuditLog[]
  client      Client?    @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([email])
  @@index([cognitoSub])
  @@index([status])
}

model DiseaseArea {
  id                     String                  @id @default(cuid())
  therapeuticArea        String
  name                   String
  code                   String                  @unique
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  campaigns              Campaign[]
  hcpDiseaseAreaScores   HcpDiseaseAreaScore[]
  liteClientDiseaseAreas LiteClientDiseaseArea[]

  @@index([therapeuticArea])
  @@index([isActive])
}

model Specialty {
  id          String         @id @default(cuid())
  name        String         @unique
  code        String         @unique
  category    String?        // e.g., "Medical", "Surgical", "Primary Care"
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  hcps        HcpSpecialty[]

  @@index([category])
  @@index([isActive])
}

model HcpSpecialty {
  id          String    @id @default(cuid())
  hcpId       String
  specialtyId String
  isPrimary   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  hcp         Hcp       @relation(fields: [hcpId], references: [id], onDelete: Cascade)
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([hcpId, specialtyId])
  @@index([hcpId])
  @@index([specialtyId])
}

model LiteClientDiseaseArea {
  id            String      @id @default(cuid())
  clientId      String
  diseaseAreaId String
  isActive      Boolean     @default(true)
  expiresAt     DateTime?
  grantedBy     String
  grantedAt     DateTime    @default(now())
  client        Client      @relation(fields: [clientId], references: [id])
  diseaseArea   DiseaseArea @relation(fields: [diseaseAreaId], references: [id])

  @@unique([clientId, diseaseAreaId])
  @@index([clientId])
  @@index([diseaseAreaId])
}

model ClientHcpExclusion {
  id        String   @id @default(cuid())
  clientId  String
  hcpId     String
  reason    String?
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  hcp       Hcp      @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  @@unique([clientId, hcpId])
  @@index([clientId])
  @@index([hcpId])
}

model CampaignHcpExclusion {
  id         String   @id @default(cuid())
  campaignId String
  hcpId      String
  reason     String?
  createdBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  hcp        Hcp      @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  @@unique([campaignId, hcpId])
  @@index([campaignId])
  @@index([hcpId])
}

model Hcp {
  id                  String                  @id @default(cuid())
  npi                 String                  @unique
  firstName           String
  lastName            String
  email               String?
  specialty           String?                 // Legacy field - kept for backward compatibility
  subSpecialty        String?
  city                String?
  state               String?
  yearsInPractice     Int?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  createdBy           String?
  specialties         HcpSpecialty[]
  campaignHcps        CampaignHcp[]
  aliases             HcpAlias[]
  campaignScores      HcpCampaignScore[]
  diseaseAreaScores   HcpDiseaseAreaScore[]
  nominationsReceived Nomination[]            @relation("NominatedHcp")
  nominationsGiven    Nomination[]            @relation("NominatorHcp")
  payments            Payment[]
  surveyResponses     SurveyResponse[]
  clientExclusions    ClientHcpExclusion[]
  campaignExclusions  CampaignHcpExclusion[]

  @@index([npi])
  @@index([lastName, firstName])
  @@index([specialty])
  @@index([state])
}

model HcpAlias {
  id        String   @id @default(cuid())
  hcpId     String
  aliasName String
  createdBy String?
  createdAt DateTime @default(now())
  hcp       Hcp      @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  @@unique([hcpId, aliasName])
  @@index([aliasName])
}

model HcpDiseaseAreaScore {
  id                   String      @id @default(cuid())
  hcpId                String
  diseaseAreaId        String
  scorePublications    Decimal?    @db.Decimal(5, 2)
  scoreClinicalTrials  Decimal?    @db.Decimal(5, 2)
  scoreTradePubs       Decimal?    @db.Decimal(5, 2)
  scoreOrgLeadership   Decimal?    @db.Decimal(5, 2)
  scoreOrgAwareness    Decimal?    @db.Decimal(5, 2)
  scoreConference      Decimal?    @db.Decimal(5, 2)
  scoreSocialMedia     Decimal?    @db.Decimal(5, 2)
  scoreMediaPodcasts   Decimal?    @db.Decimal(5, 2)
  scoreSurvey          Decimal?    @db.Decimal(5, 2)
  totalNominationCount Int         @default(0)
  compositeScore       Decimal?    @db.Decimal(5, 2)
  isCurrent            Boolean     @default(true)
  effectiveFrom        DateTime    @default(now())
  effectiveTo          DateTime?
  campaignCount        Int         @default(0)
  lastCalculatedAt     DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  diseaseArea          DiseaseArea @relation(fields: [diseaseAreaId], references: [id])
  hcp                  Hcp         @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  @@index([hcpId, diseaseAreaId, isCurrent])
  @@index([diseaseAreaId, isCurrent])
  @@index([hcpId, isCurrent])
}

model HcpCampaignScore {
  id                     String    @id @default(cuid())
  hcpId                  String
  campaignId             String
  // 6 nomination type scores (matching database)
  scoreDiscussionLeaders Decimal?  @db.Decimal(5, 2)
  countDiscussionLeaders Int       @default(0)
  scoreReferralLeaders   Decimal?  @db.Decimal(5, 2)
  countReferralLeaders   Int       @default(0)
  scoreAdviceLeaders     Decimal?  @db.Decimal(5, 2)
  countAdviceLeaders     Int       @default(0)
  scoreNationalLeader    Decimal?  @db.Decimal(5, 2)
  countNationalLeader    Int       @default(0)
  scoreRisingStar        Decimal?  @db.Decimal(5, 2)
  countRisingStar        Int       @default(0)
  scoreSocialLeader      Decimal?  @db.Decimal(5, 2)
  countSocialLeader      Int       @default(0)
  // Consolidated score
  scoreSurvey            Decimal?  @db.Decimal(5, 2)
  nominationCount        Int       @default(0)
  compositeScore         Decimal?  @db.Decimal(5, 2)
  calculatedAt           DateTime?
  publishedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  campaign               Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  hcp                    Hcp       @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  @@unique([hcpId, campaignId])
  @@index([campaignId])
  @@index([hcpId])
}

model ScoreImportBatch {
  id              String   @id @default(cuid())
  diseaseAreaId   String
  fileName        String
  recordsTotal    Int
  recordsImported Int
  recordsSkipped  Int
  importedBy      String
  importedAt      DateTime @default(now())
  notes           String?

  @@index([diseaseAreaId])
  @@index([importedAt])
}

model Question {
  id               String            @id @default(cuid())
  text             String
  type             QuestionType
  category         String?
  isRequired       Boolean           @default(false)
  options          Json?
  tags             String[]
  status           String            @default("active")
  usageCount       Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  minEntries       Int?
  defaultEntries   Int?
  nominationType   NominationType?   // For nomination questions: which type of KOL
  sectionQuestions SectionQuestion[]
  surveyQuestions  SurveyQuestion[]

  @@index([category])
  @@index([type])
  @@index([status])
  @@index([nominationType])
}

model SectionTemplate {
  id               String            @id @default(cuid())
  name             String
  description      String?
  isCore           Boolean           @default(false)
  sortOrder        Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  questions        SectionQuestion[]
  templateSections TemplateSection[]

  @@index([isCore])
}

model SectionQuestion {
  id         String          @id @default(cuid())
  sectionId  String
  questionId String
  sortOrder  Int             @default(0)
  question   Question        @relation(fields: [questionId], references: [id])
  section    SectionTemplate @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([sectionId, questionId])
  @@index([sectionId])
}

model SurveyTemplate {
  id          String            @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  campaigns   Campaign[]
  sections    TemplateSection[]
}

model TemplateSection {
  id         String          @id @default(cuid())
  templateId String
  sectionId  String
  sortOrder  Int             @default(0)
  isLocked   Boolean         @default(false)
  section    SectionTemplate @relation(fields: [sectionId], references: [id])
  template   SurveyTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, sectionId])
  @@index([templateId])
}

model Campaign {
  id                       String                  @id @default(cuid())
  clientId                 String
  diseaseAreaId            String
  surveyTemplateId         String?
  name                     String
  description              String?
  status                   CampaignStatus          @default(DRAFT)
  honorariumAmount         Decimal?                @db.Decimal(10, 2)
  surveyOpenDate           DateTime?
  surveyCloseDate          DateTime?
  publishedAt              DateTime?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  createdBy                String?
  invitationEmailBody      String?
  invitationEmailSubject   String?
  reminderEmailBody        String?
  reminderEmailSubject     String?
  surveyAlreadyDoneMessage String?
  surveyAlreadyDoneTitle   String?
  surveyThankYouMessage    String?
  surveyThankYouTitle      String?
  surveyWelcomeMessage     String?
  surveyWelcomeTitle       String?
  // Workflow step confirmation timestamps (when user explicitly reviewed/confirmed each step)
  scoreConfigConfirmedAt   DateTime?
  templatesConfirmedAt     DateTime?
  client                   Client                  @relation(fields: [clientId], references: [id])
  diseaseArea              DiseaseArea             @relation(fields: [diseaseAreaId], references: [id])
  surveyTemplate           SurveyTemplate?         @relation(fields: [surveyTemplateId], references: [id])
  campaignHcps             CampaignHcp[]
  compositeScoreConfig     CompositeScoreConfig?
  hcpCampaignScores        HcpCampaignScore[]
  hcpExclusions            CampaignHcpExclusion[]
  optOuts                  OptOut[]
  payments                 Payment[]
  surveyQuestions          SurveyQuestion[]
  surveyResponses          SurveyResponse[]

  @@index([clientId])
  @@index([diseaseAreaId])
  @@index([status])
}

model CampaignHcp {
  id             String    @id @default(cuid())
  campaignId     String
  hcpId          String
  surveyToken    String    @unique @default(cuid())
  emailSentAt    DateTime?
  reminderCount  Int       @default(0)
  lastReminderAt DateTime?
  createdAt      DateTime  @default(now())
  campaign       Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  hcp            Hcp       @relation(fields: [hcpId], references: [id])

  @@unique([campaignId, hcpId])
  @@index([surveyToken])
  @@index([campaignId])
}

model SurveyQuestion {
  id                   String                 @id @default(cuid())
  campaignId           String
  questionId           String
  sectionName          String
  sortOrder            Int                    @default(0)
  isRequired           Boolean                @default(false)
  questionTextSnapshot String
  nominationType       NominationType?        // Frozen copy of nomination type
  createdAt            DateTime               @default(now())
  nominations          Nomination[]
  campaign             Campaign               @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  question             Question               @relation(fields: [questionId], references: [id])
  answers              SurveyResponseAnswer[]

  @@index([campaignId])
  @@index([nominationType])
}

model CompositeScoreConfig {
  id                   String   @id @default(cuid())
  campaignId           String   @unique
  weightPublications   Decimal  @default(10) @db.Decimal(5, 2)
  weightClinicalTrials Decimal  @default(15) @db.Decimal(5, 2)
  weightTradePubs      Decimal  @default(10) @db.Decimal(5, 2)
  weightOrgLeadership  Decimal  @default(10) @db.Decimal(5, 2)
  weightOrgAwareness   Decimal  @default(10) @db.Decimal(5, 2)
  weightConference     Decimal  @default(10) @db.Decimal(5, 2)
  weightSocialMedia    Decimal  @default(5) @db.Decimal(5, 2)
  weightMediaPodcasts  Decimal  @default(5) @db.Decimal(5, 2)
  weightSurvey         Decimal  @default(25) @db.Decimal(5, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  campaign             Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model SurveyResponse {
  id              String                 @id @default(cuid())
  campaignId      String
  respondentHcpId String
  surveyToken     String                 @unique
  status          SurveyResponseStatus   @default(PENDING)
  startedAt       DateTime?
  completedAt     DateTime?
  ipAddress       String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  nominations     Nomination[]
  payment         Payment?
  campaign        Campaign               @relation(fields: [campaignId], references: [id])
  respondentHcp   Hcp                    @relation(fields: [respondentHcpId], references: [id])
  answers         SurveyResponseAnswer[]

  @@index([campaignId])
  @@index([respondentHcpId])
  @@index([surveyToken])
  @@index([status])
}

model SurveyResponseAnswer {
  id         String         @id @default(cuid())
  responseId String
  questionId String
  answerText String?
  answerJson Json?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  question   SurveyQuestion @relation(fields: [questionId], references: [id])
  response   SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
  @@index([questionId])
}

model Nomination {
  id              String                @id @default(cuid())
  responseId      String
  questionId      String
  nominatorHcpId  String
  rawNameEntered  String
  matchedHcpId    String?
  matchStatus     NominationMatchStatus @default(UNMATCHED)
  matchedBy       String?
  matchedAt       DateTime?
  createdAt       DateTime              @default(now())
  matchConfidence Int?
  matchType       String?
  excludeReason   String?
  matchedHcp      Hcp?                  @relation("NominatedHcp", fields: [matchedHcpId], references: [id])
  nominatorHcp    Hcp                   @relation("NominatorHcp", fields: [nominatorHcpId], references: [id])
  question        SurveyQuestion        @relation(fields: [questionId], references: [id])
  response        SurveyResponse        @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@index([responseId])
  @@index([questionId])
  @@index([matchStatus])
  @@index([matchedHcpId])
  @@index([rawNameEntered])
}

model Payment {
  id                  String                 @id @default(cuid())
  campaignId          String
  hcpId               String
  responseId          String                 @unique
  amount              Decimal                @db.Decimal(10, 2)
  currency            String                 @default("USD")
  status              PaymentStatus          @default(PENDING_EXPORT)
  statusUpdatedAt     DateTime?
  exportedAt          DateTime?
  exportBatchId       String?
  externalReferenceId String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  campaign            Campaign               @relation(fields: [campaignId], references: [id])
  exportBatch         PaymentExportBatch?    @relation(fields: [exportBatchId], references: [id])
  hcp                 Hcp                    @relation(fields: [hcpId], references: [id])
  response            SurveyResponse         @relation(fields: [responseId], references: [id])
  statusHistory       PaymentStatusHistory[]

  @@unique([campaignId, hcpId])
  @@index([campaignId])
  @@index([status])
}

model PaymentExportBatch {
  id          String    @id @default(cuid())
  campaignId  String
  exportedBy  String
  exportedAt  DateTime  @default(now())
  recordCount Int
  fileName    String?
  notes       String?
  payments    Payment[]

  @@index([campaignId])
}

model PaymentStatusHistory {
  id            String         @id @default(cuid())
  paymentId     String
  oldStatus     PaymentStatus?
  newStatus     PaymentStatus
  changedAt     DateTime       @default(now())
  changedBy     String?
  importBatchId String?
  payment       Payment        @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
}

model PaymentImportBatch {
  id             String   @id @default(cuid())
  campaignId     String
  importedBy     String
  importedAt     DateTime @default(now())
  fileName       String
  recordCount    Int
  matchedCount   Int
  unmatchedCount Int
  status         String

  @@index([campaignId])
}

model OptOut {
  id              String      @id @default(cuid())
  hcpId           String?
  email           String
  scope           OptOutScope
  campaignId      String?
  reason          String?
  optedOutAt      DateTime    @default(now())
  optedOutVia     String
  resubscribedAt  DateTime?
  resubscribedVia String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  campaign        Campaign?   @relation(fields: [campaignId], references: [id])

  @@index([email])
  @@index([scope])
  @@index([campaignId])
}

model AuditLog {
  id         String    @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime  @default(now())
  actorType  ActorType @default(USER)
  metadata   Json?
  tenantId   String?
  user       User?     @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
}

model DashboardConfig {
  id          String               @id @default(cuid())
  clientId    String
  campaignId  String               @unique
  name        String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  createdBy   String?
  isPublished Boolean              @default(false)
  components  DashboardComponent[]

  @@index([clientId])
  @@index([campaignId])
}

model DashboardComponent {
  id            String                 @id @default(cuid())
  dashboardId   String
  componentType DashboardComponentType
  componentKey  String
  configJson    Json?
  sectionTitle  String
  displayOrder  Int                    @default(0)
  isVisible     Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  dashboard     DashboardConfig        @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@index([componentKey])
}

enum UserRole {
  PLATFORM_ADMIN
  CLIENT_ADMIN
  TEAM_MEMBER
}

enum UserStatus {
  PENDING_VERIFICATION
  PENDING_APPROVAL
  ACTIVE
  DISABLED
}

enum ClientType {
  FULL
  LITE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  CLOSED
  PUBLISHED
}

enum SurveyResponseStatus {
  PENDING
  OPENED
  IN_PROGRESS
  COMPLETED
  EXCLUDED
}

enum NominationMatchStatus {
  UNMATCHED
  MATCHED
  NEW_HCP
  EXCLUDED
  REVIEW_NEEDED
}

enum PaymentStatus {
  PENDING_EXPORT
  EXPORTED
  EMAIL_SENT
  EMAIL_DELIVERED
  EMAIL_OPENED
  CLAIMED
  BOUNCED
  REJECTED
  EXPIRED
}

enum OptOutScope {
  CAMPAIGN
  GLOBAL
}

enum QuestionType {
  TEXT
  NUMBER
  RATING
  SINGLE_CHOICE
  MULTI_CHOICE
  DROPDOWN
  MULTI_TEXT
}

// Nomination types for categorizing HCP nominations
enum NominationType {
  DISCUSSION_LEADERS // Discussion Leaders in the field
  REFERRAL_LEADERS   // Referral Leaders / trusted colleagues
  ADVICE_LEADERS     // Advice Leaders for clinical guidance
  NATIONAL_LEADER    // National KOL / thought leader
  RISING_STAR        // Emerging/up-and-coming KOL
  SOCIAL_LEADER      // Social media / digital influencer
}

enum ActorType {
  USER
  SYSTEM
  API_KEY
}

enum DashboardComponentType {
  STANDARD
  CUSTOM
}
